---
title: "Methods and tools to measure ecosystem metabolism"
author: "Dr. Marcus Beck $\\bullet$ mbeck\\@tbep.org $\\bullet$ \\@fawda123"
institute: "Program Scientist, Tampa Bay Estuary Program"
date: "Aug. 21, 2020"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
---

```{r, message = F, echo = F, warning = F}
library(knitr)
library(xaringanthemer)

# global knitr options
opts_chunk$set(message = FALSE, dev.args = list(family = 'serif'), echo = F, warning = F)

style_mono_accent(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono")
)

# chunk hook for par
knit_hooks$set(par = function(before, options, envir){
  if (before && options$fig.show!='none') par(mar=c(4,4,.1,.1))
})

library(SWMPr)
library(ggplot2)

theme_mine <- function (base_size = 12, base_family = "") {
  theme_bw(base_size = base_size, base_family = base_family) %+replace% 
  theme(
    plot.background = element_rect(fill='transparent', 
      colour = NA),
    panel.background = element_rect(fill='transparent', 
      colour = NA),
    legend.background = element_rect(fill='transparent', 
      colour = NA),
    # strip.background = element_rect(fill = 
        # alpha(pal(5)[5],0.5)),
    legend.key = element_rect(fill = 'transparent', 
      colour = NA)
    )   
}

# set as default
theme_set(theme_mine())
```

class: center, middle, inverse

# A bit of history

---

# The need for data analysis tools at NERRS

#### NERRS researchers, managers, technicians, and stakeholders need more quantitative tools for handling data: 

* Understand regional and national trends while retaining the ability to determine local trends

* Train users

* Maintain a versatile and evolving data analysis approach

* Create a community of practice

---

# Genesis of SWMPrats

```{r, echo = F}
knitr::include_graphics('figure/bg_main.jpg')
```

#### One-day training workshop at 2014 annual meeting

* Attended by over 70 NERRS staff, representing 19 of 28 reserves

* General focus on time series analysis, simple application with SWMP data

* Pre/post workshop materials including An R package for SWMP

---

## Genesis of SWMPrats

```{r, echo = F}
knitr::include_graphics('figure/swmprats_logo.png')
```

#### A working group was formed from this meeting

### <u>S</u>ystem-<u>W</u>ide <u>M</u>onitoring <u>P</u>rogram <u>R</u>esources for the <u>A</u>nalysis of <u>T</u>ime <u>S</u>eries

#### [SWMPrats.net](SWMPrats.net) was the base of operations...

---

class: center, top

## SWMPrats.net

A website with information and tools for SWMP data analysis

```{r, echo = F, out.width = '70%'}
knitr::include_graphics('figure/swmprats_home.png')
```

---

## SWMPrats.net: Interactive web apps

.pull-left[
The most common question - what's happened at my site over time? 

Three Shiny applications allow users to visualize trends in SWMP data, these apps allow *reactive* use of SWMPr functions

<br></br>
```{r, out.width = "70%"}
knitr::include_graphics('figure/swmp_summary.png')
```
]

.pull-right[
```{r, out.width = "80%"}
knitr::include_graphics('figure/swmp_comp.png')
```
<br></br>
```{r, out.width = "80%"}
knitr::include_graphics('figure/swmp_agg.png')
```
]

---

## SWMPrats.net: The SWMPr package

```{r, echo = F, out.width = '90%', fig.align = 'center'}
knitr::include_graphics('figure/swmpr_logo.png')
```

SWMPr is an open-source R package for working with SWMP data

```{r eval = F}
# install/load from R
install.packages('SWMPr')
library(SWMPr)
```

* Dealing with "bad" data

* Subsetting by date ranges, parameters

* Combining data from different sites

* Standardizing time steps

.pull-right[*Full details in Beck 2016, The R Journal, 8(1)]

---

## The current state of affairs

* SWMPr is still maintained but not under active development

* The SWMPrExtension package provides a suite of tools that build on SWMPr, with a leaning towards automated reporting

```{r, echo = F, out.width = '90%', fig.align = 'center'}
knitr::include_graphics('figure/swmpr_extension_logo.png')
```

<https://github.com/NOAA-OCM/SWMPrExtension>

---

class: center, middle, inverse

# What about ecosystem metabolism?

---

## Buried in the SWMPr package...

```{r}
knitr::include_graphics('figure/ecometabfunc.PNG')
```

---

## In just a few short steps, estimate metabolism

```{r, results = 'hide', echo = T, message = F}
library(SWMPr)

# import and clean data
wq <- qaqc(apadbwq)
met <- qaqc(apaebmet)

# combine wq and met
dat <- comb(wq, met)

# estimate metabolism
res <- ecometab(dat)
```

.pull-right[*Methods from Murrell et al. 2017, Estuaries & Coasts 41(3)]

---

## In just a few short steps, estimate metabolism

```{r, echo = T, fig.align = 'center', fig.width = 10, fig.height = 5}
plot_metab(res)
```

---

class: middle, center, inverse

# Metabolic estimates have baggage

---

## Methodological assumptions

* Requires an accurate DO time series of the diel cycle

* Requires accurate estimate of air-sea gas exchange

* Assumes water column is well-mixed

* Assumes sensor is sampling the same water mass over time

---

Plot of SAPDC DO and tidal height

---

Tidal advection removal method before/after, anomalous values

---

Method can be improved, compared to other metabolic estimation methods

---

## Take home messages

* You have some pre-existing tools at your disposal

* They can be improved to better satisfy requirements of the data

* They can be improved to suit your needs!  

* Metabolism as a standard unit of comparison between reserves, measure of ecosystem health



