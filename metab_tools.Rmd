---
title: "Methods and tools to measure ecosystem metabolism"
author: "Dr. Marcus Beck $\\bullet$ mbeck\\@tbep.org $\\bullet$ \\@fawda123"
institute: "Program Scientist, Tampa Bay Estuary Program"
date: "Aug. 21, 2020"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
---

```{r, message = F, echo = F, warning = F}
library(knitr)
library(xaringanthemer)
library(SWMPr)
library(tidyverse)
library(patchwork)
library(ggforce)

# global knitr options
opts_chunk$set(message = FALSE, dev.args = list(family = 'serif'), dpi = 300, echo = F, warning = F, fig.align = 'center', out.width = '100%')

style_mono_accent(
  base_color = "#1c5253",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono")
)
```

class: center, middle, inverse

# A bit of history

---

```{r, echo = F}
knitr::include_graphics('figure/swmprats_logo.png')
```

### <u>S</u>ystem-<u>W</u>ide <u>M</u>onitoring <u>P</u>rogram <u>R</u>esources for the <u>A</u>nalysis of <u>T</u>ime <u>S</u>eries

#### [SWMPrats.net](SWMPrats.net)

.pull-left[
* Web resources for SWMP data analysis

* Workshop training materials and cookbooks

* Discussion forum 

* Interactive dashboards

]

.pull-right[
```{r, out.width = "90%"}
knitr::include_graphics('figure/swmp_comp.png')
```
]

---

## SWMPrats.net: The SWMPr package

```{r, echo = F, out.width = '90%', fig.align = 'center'}
knitr::include_graphics('figure/swmpr_logo.png')
```

[SWMPr](https://github.com/fawda123/SWMPr) is an open-source R package for working with SWMP data

```{r eval = F}
# install/load from R
install.packages('SWMPr')
library(SWMPr)
```

* Dealing with "bad" data

* Subsetting by date ranges, parameters

* Combining data from different sites

* Standardizing time steps

 <span style="float:right;">*[Beck 2016](https://journal.r-project.org/archive/2016/RJ-2016-015/index.html), The R Journal, 8(1)</span>

---

## The current state of affairs

* SWMPrats is no more

* SWMPr is still maintained but not under active development

--

* The SWMPrExtension package provides a suite of tools that build on SWMPr, with a leaning towards automated reporting

```{r, echo = F, out.width = '90%', fig.align = 'center'}
knitr::include_graphics('figure/swmpr_extension_logo.png')
```

<span style="float:right;">*<https://github.com/NOAA-OCM/SWMPrExtension></span>

---

class: center, middle, inverse

# What about ecosystem metabolism?

---

## Buried in the SWMPr package...

```{r}
knitr::include_graphics('figure/ecometabfunc.PNG')
```

---

## In just a few short steps, estimate metabolism

```{r, results = 'hide', echo = T, message = F}
library(SWMPr)

# import and clean data
wq <- qaqc(apadbwq)
met <- qaqc(apaebmet)

# combine wq and met
dat <- comb(wq, met)

# estimate metabolism
res <- ecometab(dat)
```

<br>
<span style="float:right;">*Methods from [Murrell et al. 2017](https://link.springer.com/article/10.1007/s12237-017-0328-9), Estuaries & Coasts 41(3)</span>

---

## In just a few short steps, estimate metabolism

```{r, echo = T, fig.align = 'center', fig.width = 10, fig.height = 5}
plot_metab(res)
```

---

class: middle, center, inverse

# Metabolic estimates have baggage

---

## Methodological assumptions

#### The Odum open-water method can provide an estimate of whole-system metabolic rates

$$
\frac{\delta DO}{\delta t} = P - R + D
$$
--

<br>

* Requires an accurate and continuous DO time series of the diel cycle

* Requires accurate estimate of air-sea gas exchange

* Assumes water column is well-mixed

* Assumes sensor is sampling the same water mass over time

<br>
<span style="float:right;">*Odum 1956, Limnology and Oceanography 1</span>

---

## Tidal advection is a nuisance

```{r, fig.height = 5, fig.width = 9, fig.align = 'center'}
dts <- as.Date(c('2012-02-01','2012-02-08')) 

load('data/SAPDC_wtreg_12.RData')

# raw data to plot
toplo <- get('SAPDC_wtreg_12') %>% 
  filter(met.date >= dts[1] & met.date <= dts[2])

# day rectangles
toplorect <- toplo %>% 
  select(variable, met.date, DateTimeStamp) %>% 
  group_by(met.date) %>% 
  filter(variable %in% 'sunrise') %>% 
  filter(1:length(variable) %in% c(1, length(variable))) %>% 
  mutate(
    xval = case_when(
      seq_along(variable) == 1 ~ 'xmin', 
      seq_along(variable) == 2 ~ 'xmax'
    )
  ) %>% 
  ungroup %>% 
  spread(xval, DateTimeStamp) %>% 
  select(xmin, xmax)

pthm <- theme_minimal() +
  theme(
    legend.position = 'none', 
    axis.title.x = element_blank(), 
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(), 
    panel.grid.minor.y = element_blank(), 
    axis.ticks.x = element_line()
    ) 

p1 <- ggplot() + 
  geom_rect(data = toplorect, aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf), fill = 'orange', alpha = 0.5) +
  geom_line(data = toplo, aes(x = DateTimeStamp, y = DO_obs), colour = '#1c5253', size = 1) +
  labs( 
    y = expression(paste('DO (mg ',L^-1,')')),
    title = 'Sapelo Island, 2012 DO and tidal height', 
    subtitle = 'Sunrise to sundown shown in orange'
    ) + 
  pthm

p2 <-ggplot() + 
  geom_rect(data = toplorect, aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf), fill = 'orange', alpha = 0.5) +
  geom_line(data = toplo, aes(x = DateTimeStamp, y = Tide), colour = '#1c5253', size = 1) +
  labs( 
    y = 'Height (m)'
    ) + 
  pthm

p1 + p2 + plot_layout(ncol = 1)
```

---

## Leads to "anomalous" estimates

```{r, fig.height = 5, fig.width = 9, fig.align = 'center'}
library(WtRegDO)
dts <- as.Date(c('2012-02-01','2012-02-08')) 

data(metab_obs)
p <- plot(metab_obs, by = 'days') + facet_zoom(x = Date >= as.numeric(dts[1]) & Date <= as.numeric(dts[2]), zoom.size = 1)
p
```

---

class: middle, center, inverse

# We can get fancy

---

## Detiding the DO signal

```{r, fig.height = 5, fig.width = 9, fig.align = 'center'}
p1 <- ggplot() + 
  geom_rect(data = toplorect, aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf), fill = 'orange', alpha = 0.5) +
  geom_line(data = toplo, aes(x = DateTimeStamp, y = DO_obs), colour = '#1c5253', size = 1) +
  labs( 
    y = expression(paste('Obs. DO (mg ',L^-1,')')),
    title = 'Sapelo Island, 2012 observed and detided DO', 
    subtitle = 'Sunrise to sundown shown in orange'
    ) + 
  pthm

p2 <-ggplot() + 
  geom_rect(data = toplorect, aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf), fill = 'orange', alpha = 0.5) +
  geom_line(data = toplo, aes(x = DateTimeStamp, y = DO_nrm), colour = '#1c5253', size = 1) +
  labs( 
    y = expression(paste('Detided DO (mg ',L^-1,')'))
    ) + 
  pthm

p1 + p2 + plot_layout(ncol = 1)
```

<span style="float:right;">*[WtRegDO](https://github.com/fawda123/WtRegDO) R package, [Beck et al. 2015](https://doi.org/10.1002/lom3.10062), L & O Methods, 13(12)</span>

---

## Leads to "better" estimates

```{r, fig.height = 5, fig.width = 9, fig.align = 'center'}
data(metab_dtd)
plot(metab_dtd, by = 'days') + facet_zoom(x = Date >= as.numeric(dts[1]) & Date <= as.numeric(dts[2]), zoom.size = 1)
```

---

## Why should you care?

#### You have some pre-existing tools at your disposal

* SWMPr R package: [github.com/fawda123/SWMPr](https://github.com/fawda123/SWMPr)
* WtRegDO R package: [github.com/fawda123/WtRegDO](https://github.com/fawda123/WtRegDO)

--

#### They can be improved to better satisfy requirements of the data
   
* Better constrain metabolism assumptions
* Field data to support stats models

--

#### They can be improved to suit your needs!  

* What types of products would you like to see?

--

#### Metabolism as a standard unit of comparison, measure of ecosystem health

* Measure process rates, ripe for cross-reserve comparison

---

class: middle, center, inverse

# Survey responses

---

# Survey goals

* Help us better understand your needs to develop applied research tools

* Gauge interest in participation

* Facilitate discussion 

---

### Q1: What are some historical or current management issues at your reserve that may be of interest for applying new methods to help understand ecosystem processes?   

1. As a multi-component reserve, we have two tidal fresh, and one tidal brackish system, each with their own unique needs and challenges (eg urban vs rural inputs, SLR, saltwater intrusion, etc).
1. Episodic freshwater inflows, hypersalinity during droughts, highly nitrogen limited system, nitrogen fixation, denitrification, role of organic N
1. blue carbon
1. Riverine nutrient loading, Stormwater pollution, invasive algal species - significant increases in autotrophic biomass, changes in watershed land-use, increased stormwater flashiness
1. how watershed alterations (hydrological manipulations and increases in nutrient load) affect ecosystem dynamics; potential for NEM be used as an indicator of coastal condition for regular status reports
1. climate change
1. Effects of changes in river flow to bay to bay ecosystem metabolism

---

### Q2: What questions would you like to see addressed for cross-reserve comparisons to understand ecosystem processes?

1. As a multi component reserve, sharing a watershed with another reserve, any comparisons we can make to level our understanding of our systems would help increase inter-reserve collaboration.
1. how water replacement time impacts measures of ecosystem metabolism - the water replacement time for our lagoonal, microtidal estuary is about one year on average
1. regional to national metabolic responses to climate and large-scale weather events (ocean/atmos oscillations, cyclones, etc)
1. what drives changes in ecosystem metabolism?; temporal and spatial scales of variability; can we relate water column metabolism estimates to biological observations?; does NEM reflect ecosystem health/condition?
1. Questions relative to climate change and episodic weather events
1. Are there differences in primary drivers of metabolism for each reserve, if so, what are they?

---

### Q3: Please describe any applications where you have used ecosystem metabolism. What questions were you addressing? What methods did you use to estimate metabolism?

1. None
1. We have analyzed 10 years of SWMP oxygen and met data to calculate net ecosystem metabolism and gross primary production, and look at the impacts of freshwater inflow and drought events, and made a few measurements of N fixation and denitrification in sediments
1. 2 of our SWMP stations are located in a small lagoonal estuary and are seasonally prone to large pH excursions >9.0. These were explained by seasonal shifts in system metabolism coinciding with DO, chlorohpyll, and salinity signals
1. assisted a grad student studying impacts of tropical storms on nutrient and carbon loading - Marcus' SWMPr
1. I have not been directly involved in any metabolism projects at our reserve. I know that there was metabolism work done by Neubauer, Anderson, Neikirk et al. in the late 90's through early 00's at our reserve sites.
1. We've used R and excel to calculate metabolic rates using our swmp data. Interested in the net metabolism over a long-term time scales

---

### Q4: Do you or any of your staff have experience using open-source software (e.g., R or SWMPr) to analyze SWMP data?

1. Some, but not much.
1. Yes, Research Associate Lindsay Scheef
1. limited experience
1. Yes. Some beginner level experience with both.
1. Shannon Dunnigan (our SWMP Manager) has a lot of experience
1. I use R frequently to analyze SWMP data
1. Yep

---

### Q5: Anything else you'd like us to know?

1. I'm excited to learn and help contribute our long term SWMP data to this effort, but our current staffing capacity is very low.
1. We are also looking at how phytoplankton biomass and zooplankton populations respond to freshwater inflows, gross primary production and net ecosystem metabolism
1. I'm excited to participate in this!
1. Not right now?
