---
title: "2022 State of the Bay"
author: 
   - name: Dr. Marcus Beck, <mbeck@tbep.org>, Kerry Flaherty-Walia <kfwalia@tbep.org>
institute: "Tampa Bay Estuary Program"
date: "February, 2023"
date-format: "MMM, YYYY"
format:
  revealjs:
    logo: figure/TBEP_logo.png
    transition: slide
    footer: "Tampa Bay Estuary Program February Board Meetings"
    theme: styles.scss
    link-external-icon: true
    linkcolor: "#00806E"
    link-external-newwindow: true
execute:
  echo: false
---

```{r}
#| include: false
library(knitr)
library(tbeptools)
library(ggplot2)
library(patchwork)
library(gridExtra)
library(dplyr)
library(here)
library(ggplot2)
library(lubridate)

maxyr <- 2022
partialyr <- F

# get legend from an existing ggplot object
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

load(file = here('data/sgsegest.RData'))
load(file = url('https://github.com/tbep-tech/habitat-report-card/raw/main/tabs/tab2022.RData'))
```

------------------------------------------------------------------------

## 2022 SEAGRASS RESULTS

```{r}
show_seagrasscoverage(seagrass, lastlab = 'acres (provisional)')
```

------------------------------------------------------------------------

## 2022 SEAGRASS RESULTS

```{r}
seagrass %>% 
  select(-Hectares) %>% 
  mutate(
    difv = c(NA, diff(Acres)), 
    perc = paste0(round(100 * difv / lag(Acres), 0), '%'), 
    Acres = as.integer(round(Acres, 0))
  ) %>% 
  select(Year, Acres, `Change` = difv, `% change` = perc) %>% 
  filter(Year > 2009) %>% 
  knitr::kable()
```

------------------------------------------------------------------------

## 2022 SEAGRASS RESULTS: SEGMENT

```{r}

toplo <- sgsegest %>% 
  filter(!segment %in% c('Boca Ciega Bay', 'Terra Ceia Bay', 'Manatee River')) %>% 
  mutate(acres = acres / 1000)

ggplot(toplo, aes(x = factor(year), y = acres)) +
  geom_bar(fill = '#00806E', stat = 'identity', colour = 'black', width = 0.6) +
  facet_wrap(~segment, ncol = 2, scales = 'free') +
  theme(panel.grid.minor=element_blank(),
        panel.grid.major=element_blank(),
        plot.background = element_rect(fill = NA, color = NA),
        axis.text.y = element_text(colour = 'black'),
        plot.title = element_text(size = 22, colour = 'black'),
        legend.text = element_text(size = 16, colour = 'black'),
        axis.text.x = element_text(colour = 'black', angle = 45, size = 8, hjust = 1), 
        strip.background = element_blank(), 
        strip.text = element_text(hjust = 0, size = 13)
  ) + 
  labs(
    y = 'Seagrass Coverage (x1,000 acres)', 
    x = NULL
  )
```

------------------------------------------------------------------------

## 2022 SEAGRASS TRANSECT RESULTS

```{r}
transectocc <- anlz_transectocc(transect)
show_transectavespp(transectocc, bay_segment = c('OTB', 'HB', 'MTB', 'LTB')) +
  labs(title = NULL)
```

More info at <https://shiny.tbep.org/seagrasstransect-dash/>

------------------------------------------------------------------------

## WATER QUALITY REPORT CARD

<https://tbep-tech.github.io/wq-static/wq.pdf>

::: {.columns style="display: flex !important; height: 80%;"}
::: {.column width="50%" style="display: flex; justify-content: center; align-items: center;"}
![Management](figure/wq2022prov1.jpg){width="360"}
:::

::: {.column width="50%" style="display: flex; justify-content: center; align-items: center;"}
![Regulatory](figure/wq2022prov2.jpg){width="360"}
:::
:::

------------------------------------------------------------------------

## MANAGEMENT ACTIONS

-   Each bay segment assigned a management action

![](figure/wqactions.jpg)

------------------------------------------------------------------------

## MANAGEMENT RESULTS

![](figure/wq2022segfinal.PNG)

------------------------------------------------------------------------

## MANAGEMENT OUTCOMES

```{r}
show_matrix(epcdata, txtsz = NULL, yrrng = c(1975, 2022), partialyr = partialyr) +
  scale_y_continuous(expand = c(0,0), breaks = sort(unique(epcdata$yr))) + 
  coord_flip() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 9))
```

More info at <https://shiny.tbep.org/wq-dash/>

------------------------------------------------------------------------

## REGULATORY OUTCOMES

```{r}
show_wqmatrix(epcdata, txtsz = NULL, yrrng = c(1975, 2022), partialyr = partialyr) +
  scale_y_continuous(expand = c(0,0), breaks = sort(unique(epcdata$yr))) + 
  coord_flip() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 9))
```

More info at <https://shiny.tbep.org/wq-dash/>

------------------------------------------------------------------------

## CHLOROPHYLL TRENDS

```{r}
#| fig-height: 6
yrrng <- c(1975, maxyr)
txtcol <- 'black'
thrthm <- theme(
    plot.background = element_rect(fill = NA, color = NA),
    axis.text.y = element_text(colour = txtcol, size = 12),
    axis.title = element_blank(),
    plot.title = element_text(size = 15, colour = txtcol),
    legend.text = element_text(size = 12, colour = txtcol),
    axis.text.x = element_text(colour = txtcol, angle = 0, size = 12, hjust = 0.5)
  )
sclx <- scale_x_continuous(breaks = seq(1975, maxyr, by = 5))
p1 <- show_thrplot(epcdata, bay_segment = "OTB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + thrthm
p1leg <- g_legend(p1)
p1 <- p1 + theme(legend.positio = 'none')
p2 <- show_thrplot(epcdata, bay_segment = "HB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + thrthm + theme(legend.position = 'none')
p3 <- show_thrplot(epcdata, bay_segment = "MTB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + thrthm + theme(legend.position = 'none')
p4 <- show_thrplot(epcdata, bay_segment = "LTB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + thrthm + theme(legend.position = 'none')

# align
# Get the widths
pA <- ggplot_gtable(ggplot_build(p1))
pB <- ggplot_gtable(ggplot_build(p2))
pC <- ggplot_gtable(ggplot_build(p3))
pD <- ggplot_gtable(ggplot_build(p4))
maxWidth = grid::unit.pmax(pA$widths[2:3], pB$widths[2:3], pD$widths[2:3], pD$widths[2:3])

# Set the widths
pA$widths[2:3] <- maxWidth
pB$widths[2:3] <- maxWidth
pC$widths[2:3] <- maxWidth
pD$widths[2:3] <- maxWidth

grid.arrange(
  p1leg,
  arrangeGrob(pA, pB, ncol = 2),
  arrangeGrob(pC, pD, ncol = 2),
  ncol = 1, heights = c(0.1, 1, 1)
)
```

------------------------------------------------------------------------

## SEASONAL TRENDS

```{r}
#| fig-height: 6
yrrng <- c(1975, maxyr)
txtcol <- 'black'
thrthm <- theme(
    plot.background = element_rect(fill = NA, color = NA),
    axis.text.y = element_text(colour = txtcol, size = 12),
    axis.title = element_blank(),
    plot.title = element_text(size = 15, colour = txtcol),
    legend.text = element_text(size = 12, colour = txtcol),
    axis.text.x = element_text(size = 10, colour = txtcol, angle = 0, hjust = 0.5)
  )

p1 <- show_boxplot(epcdata, bay_segment = "OTB", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr) + thrthm
p1leg <- g_legend(p1)
p1 <- p1 + theme(legend.position = 'none')
p2 <- show_boxplot(epcdata, bay_segment = "HB", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr) + thrthm + theme(legend.position = 'none')
p3 <- show_boxplot(epcdata, bay_segment = "MTB", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr) + thrthm + theme(legend.position = 'none')
p4 <- show_boxplot(epcdata, bay_segment = "LTB",  yrrng = yrrng, yrsel = maxyr, partialyr = partialyr) + thrthm + theme(legend.position = 'none')

# align
# Get the widths
pA <- ggplot_gtable(ggplot_build(p1))
pB <- ggplot_gtable(ggplot_build(p2))
pC <- ggplot_gtable(ggplot_build(p3))
pD <- ggplot_gtable(ggplot_build(p4))
maxWidth = grid::unit.pmax(pA$widths[2:3], pB$widths[2:3], pD$widths[2:3], pD$widths[2:3])

# Set the widths
pA$widths[2:3] <- maxWidth
pB$widths[2:3] <- maxWidth
pC$widths[2:3] <- maxWidth
pD$widths[2:3] <- maxWidth

grid.arrange(
  p1leg,
  arrangeGrob(pA, pB, ncol = 2),
  arrangeGrob(pC, pD, ncol = 2),
  ncol = 1, heights = c(0.1, 1, 1)
)
```

------------------------------------------------------------------------

## PYRODINIUM TRENDS

```{r}
# https://f50006a.eos-intl.net/F50006A/OPAC/Details/Record.aspx?BibCode=5635517
datall <- read.csv('https://f50006a.eos-intl.net/ELIBSQL12_F50006A_Documents/OTBMP_Pyrodinium_Chl_2011-2020_v101922.csv') %>% 
  select(
    yr = Year, 
    date = Sample_Date, 
    Latitude, 
    Longitude, 
    pyro = P..bahamense.Abundance..cells.L.
  )
dat2022 <- read.csv(here('data/Pyrodinium_Chla_OTBMP_2022.csv')) %>% 
  select(
    date = Date, 
    Latitude, 
    Longitude, 
    pyro = Pyrodinium..Cells.L.
  )

dat <- bind_rows(datall, dat2022) %>% 
  mutate(
    date = mdy(date), 
    yr = year(date), 
    doy = yday(date), 
    pyro = pmin(3e6, pyro), 
    pyro = ifelse(pyro == 0, NA, pyro)
  )

ggplot(subset(dat, !is.na(pyro)), aes(x = doy, y = Latitude)) + 
  geom_point(aes(fill = pyro, size = pyro), shape = 21, color = 'darkgrey') + 
  geom_point(data = subset(dat, is.na(pyro)), aes(shape = "No cells"),
             size = 1, color = "lightgrey") +
  scale_x_continuous(limits = c(0, 365)) + 
  scale_fill_viridis_c(guide = "legend", option = 'C', direction = -1, labels = c('0', '1e6', '2e6', '> 3e6'), na.value = 'lightgrey') +
  scale_size_continuous(range = c(1, 5), labels = c('0', '1e6', '2e6', '> 3e6')) +
  facet_wrap(~yr, ncol = 4) + 
  theme_bw() + 
  theme(
    strip.background = element_blank(), 
    panel.grid = element_blank(),
    legend.spacing.y = unit(-0.2, "cm")
  ) + 
  guides(fill = guide_legend(), 
         size = guide_legend(),
         shape = guide_legend(order = 1)) +
  labs(
    x = 'Day of Year', 
    shape = 'cells/L\n',
    fill = NULL, 
    size = NULL, 
    subtitle = expression(paste(italic('P. bahamense'), ' cell counts by location and date in Old Tampa Bay')),
    caption = 'Data from FWC routine monitoring stations'
  )

```

------------------------------------------------------------------------

## PYRODINIUM TRENDS

```{r}
wqatt <- anlz_avedat(epcdata) %>% 
  anlz_attain()%>% 
  filter(bay_segment == 'OTB') %>% 
  mutate(outcome = factor(outcome, levels = c('red', 'yellow', 'green')))
dat <- bind_rows(datall, dat2022) %>% 
  mutate(
    date = mdy(date), 
    yr = year(date), 
    doy = yday(date)
  ) %>% 
  left_join(wqatt, by = 'yr')

ggplot(subset(dat, !is.na(pyro)), aes(x = factor(yr), y = pyro, fill = outcome))  + 
  geom_violin(draw_quantiles = 0.5) + 
  scale_y_log10() + 
  theme_minimal() + 
  theme(
    panel.grid.major.x = element_blank(), 
    panel.grid.minor.x = element_blank(), 
    legend.position = 'none'
  ) +
  scale_fill_manual(values = c('red' = '#CC3231', 'yellow' = '#E9C318', 'green' = '#2DC938')) +
  labs(
    x = NULL, 
    y = expression(paste(italic('P. bahamense'), ' (cells/L)')), 
    title = 'OTB cell counts by year with water quality outcomes',
    caption = 'Data from FWC routine monitoring stations',
    fill = NULL
  )
```

------------------------------------------------------------------------

## PYRODINIUM TRENDS

```{r}
dat <- bind_rows(datall, dat2022) %>% 
  mutate(
    date = mdy(date), 
    yr = year(date), 
    doy = yday(date), 
    pyro = pmin(1e6, pyro), 
    pyro = ifelse(pyro == 0, NA, pyro)
  ) %>% 
  filter(yr == 2022)

epcdts <- epcdata %>% 
  filter(yr == 2022 & bay_segment == 'OTB') %>% 
  mutate(
    doy = yday(SampleTime), 
    date = format(as.Date(SampleTime), '%b %d')
  ) %>% 
  select(date, doy, Latitude, Longitude)
ggplot(subset(dat, !is.na(pyro)), aes(x = doy, y = Latitude)) + 
  geom_point(aes(fill = pyro, size = pyro), shape = 21, color = 'darkgrey') + 
  geom_point(data = subset(dat, is.na(pyro)), aes(shape = "No cells"),
             size = 1, color = "lightgrey") +
  scale_x_continuous(limits = c(150, 275)) + 
  geom_vline(data = epcdts, aes(xintercept = doy, linetype = 'EPC sample dates')) +
  scale_fill_viridis_c(guide = "legend", option = 'C', direction = -1,  breaks = c(0, 2e5, 4e5, 6e5, 8e5, 1e6), labels = c('0', '2e5', '4e5', '6e5', '8e5', '> 1e6'), na.value = 'lightgrey') +
  scale_size_continuous(range = c(1, 5), breaks = c(0, 2e5, 4e5, 6e5, 8e5, 1e6), labels = c('0', '2e5', '4e5', '6e5', '8e5', '> 1e6')) +
  scale_linetype_manual(values = 'dashed') +
  theme_bw() + 
  theme(
    strip.background = element_blank(), 
    panel.grid = element_blank(),
    legend.spacing.y = unit(-0.2, "cm")
  ) + 
  geom_text(data = epcdts, aes(x = doy, y = min(dat$Latitude), label = date), angle = 90, vjust = -0.4, hjust = 0.2) +
  guides(fill = guide_legend(order = 2), 
         size = guide_legend(order = 2),
         shape = guide_legend(order = 1), 
         linetype = guide_legend(order = 3)) +
  labs(
    x = 'Day of Year', 
    shape = 'cells/L\n',
    fill = NULL, 
    size = NULL, 
    linetype = '\n',
    subtitle = expression(paste('2022 ', italic('P. bahamense'), ' cell counts by location and date in Old Tampa Bay')), 
    caption = 'Data from FWC routine monitoring stations'
  )
```

------------------------------------------------------------------------

## NEKTON RESULTS

```{r}
tbniscr <- anlz_tbniscr(fimdata)
show_tbniscr(tbniscr)
```

More info at <https://shiny.tbep.org/nekton-dash/>

------------------------------------------------------------------------

## NEKTON RESULTS

```{r}
tbniscr <- anlz_tbniscr(fimdata)
show_tbnimatrix(tbniscr, txtsz = NULL) + 
  scale_y_continuous(expand = c(0,0), breaks = sort(unique(tbniscr$Year))) + 
  coord_flip() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 9))
```

More info at <https://shiny.tbep.org/nekton-dash/>

------------------------------------------------------------------------

## BENTHIC RESULTS

```{r}
tbbiscr <- anlz_tbbiscr(benthicdata)
show_tbbimatrix(tbbiscr, txtsz = NULL, bay_segment = c('OTB', 'HB', 'MTB', 'LTB')) + 
  scale_y_continuous(expand = c(0,0), breaks = sort(unique(tbbiscr$yr))) + 
  coord_flip() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 9))
```

More info at <https://tbep-tech.github.io/tbeptools/articles/tbbi>

------------------------------------------------------------------------

## 2022 HABITAT RESTORATION

![](https://github.com/tbep-tech/habitat-report-card/raw/main/docs/figs/bar2022.png)

------------------------------------------------------------------------

## 2022 HABITAT RESTORATION

![](https://github.com/tbep-tech/habitat-report-card/raw/main/docs/figs/totalpie.png)

------------------------------------------------------------------------

## 2022 HABITAT REPORT CARD

```{r}
show_hmpreport(acres, subtacres, hmptrgs, typ = 'targets') + labs(title = NULL)
```

------------------------------------------------------------------------

## HABITAT RESTORATION PRIORITIES

* Need to focus on oysters, intertidal wetlands (salt marsh), non-forested wetlands
* Uplands - protect existing habitat!
* Mangroves expected to expand

Additional info at <https://tbep-tech.github.io/tbeptools/articles/habitatmasterplan>

------------------------------------------------------------------------

## TAKE HOME

-   Hopeful that preliminary 2022 water quality is a beginning to longer-term improvements
-   Water quality in OTB has been highly variable, one good year does not mean a long-term improvement, key HAB events may have been missed
-   Seagrasses may continue to decline - What other stressors are at play?
-   Stick to our nitrogen load reduction efforts, but investigate other management actions to kickstart seagrass recovery
