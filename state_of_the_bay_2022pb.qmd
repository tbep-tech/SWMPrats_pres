---
title: "2022 STATE OF THE BAY"
author: 
   - name: Dr. Marcus Beck, <mbeck@tbep.org>, Kerry Flaherty-Walia <kfwalia@tbep.org>
institute: "Tampa Bay Estuary Program"
date: "February, 2023"
date-format: "MMM, YYYY"
format:
  revealjs:
    logo: figure/TBEP_logo.png
    transition: slide
    footer: "Tampa Bay Estuary Program February Board Meetings"
    theme: styles.scss
    link-external-icon: true
    linkcolor: "#00806E"
    link-external-newwindow: true
execute:
  echo: false
  fig-align: "center"
---

```{r}
#| include: false
library(knitr)
library(tbeptools)
library(ggplot2)
library(patchwork)
library(gridExtra)
library(dplyr)
library(here)
library(ggplot2)
library(lubridate)
library(tidyr)

maxyr <- 2022
partialyr <- F

# get legend from an existing ggplot object
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}

load(file = here('data/sgsegest.RData'))
load(file = url('https://github.com/tbep-tech/habitat-report-card/raw/main/tabs/tab2022.RData'))

# segment coverage targets in 1k acres
segtrgs <- tibble(
  segment = factor(c(levels(sgsegest$segment), 'Total')), 
  trgs = c(11.1, 1.751, 9.4, 7.4, 8.8, 1.1, 0.449, 40)
)  

# worst case coverage ests in 1k acres, 1982
segworst <- tibble(
  segment = factor(c(levels(sgsegest$segment), 'Total')), 
  trgs = c(5.94, 0, 4.04, 5.02, 5.77, 0.75, 0.13, 21.65)
) 
```

------------------------------------------------------------------------

## 2022 SEAGRASS RESULTS

* Baywide loss of 4,161 acres from 2020 to 2022
* Third straight reporting period with loss

```{r}
#| fig-align: "center"
#| fig-width: 6
#| fig-height: 3
show_seagrasscoverage(seagrass, lastlab = 'acres (provisional)')
```

------------------------------------------------------------------------

## {background-image="figure/sgcovani.gif" background-size="contain"}

------------------------------------------------------------------------

## 2022 SEAGRASS RESULTS: SEGMENT

* Most losses in OTB and HB, OTB is lowest coverage on record

```{r}
#| fig-align: "center"
#| fig-height: 4.5
#| fig-width: 9
toplo <- sgsegest %>%
  filter(segment %in% c('Old Tampa Bay', 'Hillsborough Bay', 'Middle Tampa Bay', 'Lower Tampa Bay')) %>%
  mutate(acres = acres / 1000) %>%
  mutate(segment = forcats::fct_drop(segment))

subsegtrgs <- segtrgs %>%
  filter(segment %in% levels(toplo$segment))

arrdf <- tibble(
  segment = factor('Old Tampa Bay', levels = levels(toplo$segment)),
  x = factor(2022),
  xend = factor(2022),
  y = 8,
  yend =  5
)

ggplot(toplo, aes(x = factor(year), y = acres)) +
  geom_bar(fill = '#00806E', stat = 'identity', colour = 'black', width = 0.6) +
  geom_hline(data = subsegtrgs, aes(yintercept = trgs, color = 'Target')) +
  geom_segment(
    data = arrdf,
    aes(x = x, xend = xend, y = y, yend = yend),
    arrow = arrow(length = grid::unit(0.5, "cm")),
    size = 2, lineend = 'round', linejoin = 'round', col = 'red'
  ) +
  scale_color_manual(values = 'red') +
  facet_wrap(~segment, ncol = 2, scales = 'free') +
  theme(panel.grid.minor=element_blank(),
        panel.grid.major=element_blank(),
        plot.background = element_rect(fill = NA, color = NA),
        axis.text.y = element_text(colour = 'black'),
        plot.title = element_text(size = 22, colour = 'black'),
        legend.text = element_text(size = 16, colour = 'black'),
        axis.text.x = element_text(colour = 'black', angle = 45, size = 8, hjust = 1),
        strip.background = element_blank(),
        strip.text = element_text(hjust = 0, size = 13),
        legend.position = 'none'
  ) +
  labs(
    y = 'Seagrass Coverage (x1,000 acres)',
    x = NULL,
    color = NULL
  )
```

------------------------------------------------------------------------

## {background-image="figure/otbsgcovani.gif" background-size="contain"}

------------------------------------------------------------------------

## 2022 SEAGRASS RESULTS: SEGMENT

* Lower bay segments relatively stable

```{r}
#| fig-align: "center"
#| fig-height: 4.25
#| fig-width: 9
toplo <- sgsegest %>%
  filter(segment %in% c('Boca Ciega Bay', 'Terra Ceia Bay', 'Manatee River')) %>%
  mutate(acres = acres / 1000) %>%
  mutate(segment = forcats::fct_drop(segment))

subsegtrgs <- segtrgs %>%
  filter(segment %in% levels(toplo$segment))

ggplot(toplo, aes(x = factor(year), y = acres)) +
  geom_bar(fill = '#00806E', stat = 'identity', colour = 'black', width = 0.6) +
  geom_hline(data = subsegtrgs, aes(yintercept = trgs, color = 'Target')) +
  scale_color_manual(values = 'red') +
  facet_wrap(~segment, ncol = 2, scales = 'free') +
  theme(panel.grid.minor=element_blank(),
        panel.grid.major=element_blank(),
        plot.background = element_rect(fill = NA, color = NA),
        axis.text.y = element_text(colour = 'black'),
        plot.title = element_text(size = 22, colour = 'black'),
        legend.text = element_text(size = 16, colour = 'black'),
        axis.text.x = element_text(colour = 'black', angle = 45, size = 8, hjust = 1),
        strip.background = element_blank(),
        strip.text = element_text(hjust = 0, size = 13),
        legend.position = 'none'
  ) +
  labs(
    y = 'Seagrass Coverage (x1,000 acres)',
    x = NULL,
    color = NULL
  )
```

------------------------------------------------------------------------

## WATER QUALITY REPORT CARD

<https://tbep-tech.github.io/wq-static/wq.pdf>

::: {.columns style="display: flex !important; height: 80%;"}

::: {.column width="50%" style="display: flex; justify-content: center; align-items: center;"}

![Management](figure/wq2022prov1.jpg){width="360"}

:::

::: {.column width="50%" style="display: flex; justify-content: center; align-items: center;"}

![Regulatory](figure/wq2022prov2.jpg){width="360"}

:::

:::

------------------------------------------------------------------------

## MANAGEMENT RESULTS

![](figure/wq2022segfinal.PNG)

------------------------------------------------------------------------

## MANAGEMENT OUTCOMES

::: columns
::: {.column width="50%"}
-   Matrix shows attainment of chlorophyll and light attenuation *targets*
-   All segments in 2022 as "Stay the Course"
-   More info at <https://shiny.tbep.org/wq-dash/>
:::

::: {.column width="50%"}
```{r}
#| fig-height: 6
#| fig-width: 3
#| fig-align: "center"
p <- show_matrix(epcdata, txtsz = NULL, yrrng = c(1975, 2022), partialyr = partialyr) +
  theme(axis.text.y = element_text(size = 8))
show_matrixplotly(p, height = 600, width = 300)
```
:::
:::

------------------------------------------------------------------------

## CHLOROPHYLL TRENDS

```{r}
#| fig-height: 6
yrrng <- c(1975, maxyr)
txtcol <- 'black'
thrthm <- theme(
    plot.background = element_rect(fill = NA, color = NA),
    axis.text.y = element_text(colour = txtcol, size = 12),
    axis.title = element_blank(),
    plot.title = element_text(size = 15, colour = txtcol),
    legend.text = element_text(size = 12, colour = txtcol),
    axis.text.x = element_text(colour = txtcol, angle = 0, size = 12, hjust = 0.5)
  )
sclx <- scale_x_continuous(breaks = seq(1975, maxyr, by = 5))
p1 <- show_thrplot(epcdata, bay_segment = "OTB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + thrthm
p1leg <- g_legend(p1)
p1 <- p1 + theme(legend.positio = 'none')
p2 <- show_thrplot(epcdata, bay_segment = "HB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + thrthm + theme(legend.position = 'none')
p3 <- show_thrplot(epcdata, bay_segment = "MTB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + thrthm + theme(legend.position = 'none')
p4 <- show_thrplot(epcdata, bay_segment = "LTB", thr = "chla", yrrng = yrrng, partialyr = partialyr) + sclx + thrthm + theme(legend.position = 'none')
# align
# Get the widths
pA <- ggplot_gtable(ggplot_build(p1))
pB <- ggplot_gtable(ggplot_build(p2))
pC <- ggplot_gtable(ggplot_build(p3))
pD <- ggplot_gtable(ggplot_build(p4))
maxWidth = grid::unit.pmax(pA$widths[2:3], pB$widths[2:3], pD$widths[2:3], pD$widths[2:3])
# Set the widths
pA$widths[2:3] <- maxWidth
pB$widths[2:3] <- maxWidth
pC$widths[2:3] <- maxWidth
pD$widths[2:3] <- maxWidth
grid.arrange(
  p1leg,
  arrangeGrob(pA, pB, ncol = 2),
  arrangeGrob(pC, pD, ncol = 2),
  ncol = 1, heights = c(0.1, 1, 1)
)
```

------------------------------------------------------------------------

## CHLOROPHYLL BY SEASON

-   *K. brevis* observed in lower Tampa Bay late 2022

```{r}
#| fig-align: "center"
yrrng <- c(1975, maxyr)
txtcol <- 'black'
thrthm <- theme(
    plot.background = element_rect(fill = NA, color = NA),
    axis.text.y = element_text(colour = txtcol, size = 12),
    axis.title = element_blank(),
    plot.title = element_text(size = 15, colour = txtcol),
    legend.text = element_text(size = 12, colour = txtcol),
    axis.text.x = element_text(size = 10, colour = txtcol, angle = 0, hjust = 0.5)
  )

p1 <- show_boxplot(epcdata, bay_segment = "OTB", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr) + thrthm
p1leg <- g_legend(p1)
p1 <- p1 + theme(legend.position = 'none')
p2 <- show_boxplot(epcdata, bay_segment = "HB", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr) + thrthm + theme(legend.position = 'none')
p3 <- show_boxplot(epcdata, bay_segment = "MTB", yrrng = yrrng, yrsel = maxyr, partialyr = partialyr) + thrthm + theme(legend.position = 'none')
p4 <- show_boxplot(epcdata, bay_segment = "LTB",  yrrng = yrrng, yrsel = maxyr, partialyr = partialyr) + thrthm + theme(legend.position = 'none') +
  geom_segment(
    aes(x = 11, xend = 11, y = 16, yend =  11),
    arrow = arrow(length = grid::unit(0.5, "cm")),
    size = 2, lineend = 'round', linejoin = 'round', col = 'red'
  )

# align
# Get the widths
pA <- ggplot_gtable(ggplot_build(p1))
pB <- ggplot_gtable(ggplot_build(p2))
pC <- ggplot_gtable(ggplot_build(p3))
pD <- ggplot_gtable(ggplot_build(p4))
maxWidth = grid::unit.pmax(pA$widths[2:3], pB$widths[2:3], pD$widths[2:3], pD$widths[2:3])

# Set the widths
pA$widths[2:3] <- maxWidth
pB$widths[2:3] <- maxWidth
pC$widths[2:3] <- maxWidth
pD$widths[2:3] <- maxWidth

grid.arrange(
  p1leg,
  arrangeGrob(pA, pB, ncol = 2),
  arrangeGrob(pC, pD, ncol = 2),
  ncol = 1, heights = c(0.1, 1, 1)
)
```

------------------------------------------------------------------------

## TAKE HOME

-   Hopeful that preliminary 2022 water quality is a beginning to longer-term improvements
-   Water quality in OTB has been highly variable, one good year does not mean a long-term improvement, key HAB events may have been missed
-   Seagrasses may continue to decline - do we need to revisit our targets and thresholds? 
-   Stick to our nitrogen load reduction efforts, but we need to act now and pursue other management actions

------------------------------------------------------------------------

## NEKTON RESULTS

::: columns
::: {.column width="50%"}
-   Nekton index reports on the health of fish and inverts
-   Responds to water quality and habitat degradation
-   2021 results show all but LTB as intermediate
-   More info at <https://shiny.tbep.org/nekton-dash/>
:::

::: {.column width="50%"}
```{r}
#| fig-height: 6
#| fig-width: 3
#| fig-align: "center"
tbniscr <- anlz_tbniscr(fimdata)
p <- show_tbnimatrix(tbniscr, txtsz = NULL) +
  theme(axis.text.y = element_text(size = 8))
show_matrixplotly(p, height = 600, width = 300)
```
:::
:::

------------------------------------------------------------------------

## NEKTON RESULTS

-   2021 drop in scores likely from red tide effects

```{r}
tbniscr <- anlz_tbniscr(fimdata)
show_tbniscr(tbniscr, plotly = T, height = 500, width = 1000)
```

------------------------------------------------------------------------

## BENTHIC RESULTS

::: columns
::: {.column width="50%"}
-   Benthic index reports on the health of aquatic organisms in or near the bay bottom
-   Responds to pollutants that can accumulate in the sediment
-   2021 results similar to previous years
-   More info at <https://tbep-tech.github.io/tbeptools/articles/tbbi>
:::

::: {.column width="50%"}
```{r}
#| fig-width: 3
#| fig-height: 6
#| fig-align: "center"
tbbiscr <- anlz_tbbiscr(benthicdata)
p <- show_tbbimatrix(tbbiscr, txtsz = NULL, bay_segment = c('OTB', 'HB', 'MTB', 'LTB')) +
  theme(axis.text.y = element_text(size = 8))
show_matrixplotly(p, height = 600, width = 300)
```
:::
:::

------------------------------------------------------------------------

## 2022 HABITAT RESTORATION

![](https://github.com/tbep-tech/habitat-report-card/raw/main/docs/figs/bar2022.png)

------------------------------------------------------------------------

## NUMBER OF PROJECTS: 2020-2022

![](https://github.com/tbep-tech/habitat-report-card/raw/main/docs/figs/totalpie.png)

------------------------------------------------------------------------

## HABITAT RESTORATION PRIORITIES

<br>

::: {.columns style="display: flex !important; height: 20%;"}
::: {.column width="33%" style="display: flex; justify-content: center; align-items: center;"}
{{< fa arrows-up-to-line size=3x >}}
:::

::: {.column width="33%" style="display: flex; justify-content: center; align-items: center;"}
{{< fa shield-halved size=3x >}}
:::

::: {.column width="33%" style="display: flex; justify-content: center; align-items: center;"}
{{< fa thumbs-up size=3x >}}
:::
:::

::: {.columns style="display: flex !important; height: 30%;"}
::: {.column width="33%" style="display: flex; justify-content: center; align-items: top;"}
Focus on seagrass, oysters, salt marsh, freshwater wetlands
:::

::: {.column width="33%" style="display: flex; justify-content: center; align-items: top;"}
Uplands - protect existing habitat!
:::

::: {.column width="33%" style="display: flex; justify-content: center; align-items: top;"}
Mangroves expected to expand
:::
:::

* Additional info at <https://tbep-tech.github.io/tbeptools/articles/habitatmasterplan>

------------------------------------------------------------------------

##

<br>

### Questions??

<br>

Marcus Beck, <mbeck@tbep.org>

Kerry Flaherty-Walia, <kfwalia@tbep.org>


------------------------------------------------------------------------

## EXTRA SLIDES

------------------------------------------------------------------------

## 2022 SEAGRASS RESULTS

```{r}
seagrass %>%
  select(-Hectares) %>%
  mutate(
    difv = c(NA, diff(Acres)),
    perc = paste0(round(100 * difv / lag(Acres), 0), '%'),
    Acres = as.integer(round(Acres, 0))
  ) %>%
  select(Year, Acres, `Change` = difv, `% change` = perc) %>%
  filter(Year > 2009) %>%
  knitr::kable() %>%
  kableExtra::kable_styling(font_size = 30)
```

------------------------------------------------------------------------

## SEAGRASS RATE OF RECOVERY

![](figure/sgrecovrate.PNG)
